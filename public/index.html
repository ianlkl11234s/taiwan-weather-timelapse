<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âè∞ÁÅ£Ê∞£Ë±°ËÆäÂåñ</title>
    <meta name="description" content="Interactive visualization of Taiwan's weather changes over time">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%23313695'/><stop offset='35%25' stop-color='%2374add1'/><stop offset='65%25' stop-color='%23fee090'/><stop offset='100%25' stop-color='%23d73027'/></linearGradient></defs><circle cx='16' cy='16' r='14' fill='url(%23g)'/></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        /* Map Container */
        .map-container {
            height: calc(100vh - 80px);
            width: 100%;
            display: flex;
            position: relative;
        }

        .map-wrapper {
            flex: 1;
            position: relative;
            height: 100%;
        }

        .map-wrapper .map {
            width: 100%;
            height: 100%;
        }

        /* Single view - hide second map */
        .map-container:not(.compare-mode) .map-wrapper:nth-child(2) {
            display: none;
        }

        /* Compare mode - show both maps side by side */
        .map-container.compare-mode .map-wrapper {
            flex: 1;
            border-right: 2px solid #dee2e6;
        }
        .map-container.compare-mode .map-wrapper:last-child {
            border-right: none;
        }

        /* Map Labels */
        .map-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        .map-container.compare-mode .map-label {
            display: block;
        }
        .map-label.temperature { color: #d73027; }
        .map-label.humidity { color: #5e3a86; }

        /* Compare mode legends */
        .compare-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        .map-container.compare-mode .compare-legend { display: block; }
        .compare-legend h5 { margin: 0 0 6px 0; font-size: 12px; }
        .compare-legend .legend-item { display: flex; align-items: center; margin: 2px 0; }
        .compare-legend .legend-color { width: 16px; height: 10px; margin-right: 6px; border-radius: 2px; }

        /* Compare mode time display */
        .compare-time-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 8px 14px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            text-align: center;
        }
        .compare-time-display.night {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .compare-time-display .date { font-size: 14px; font-weight: bold; }
        .compare-time-display .time { font-size: 12px; margin-top: 2px; }

        /* Compare mode: hide zoom on map1, show on map2 (right side) */
        .map-container.compare-mode .map-wrapper:first-child .leaflet-control-zoom {
            display: none;
        }

        /* View Toggle Button */
        .view-toggle {
            display: flex;
            gap: 2px;
            background: #e9ecef;
            border-radius: 6px;
            padding: 2px;
        }
        .view-toggle-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .view-toggle-btn:hover { background: rgba(255,255,255,0.5); }
        .view-toggle-btn.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Legacy single map support */
        #map { height: calc(100vh - 80px); width: 100%; }

        /* Time Controller */
        .time-controller {
            height: 80px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border-top: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .control-btn:hover { background: #e9ecef; }
        .control-btn.active { background: #0d6efd; color: white; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .speed-buttons {
            display: flex;
            gap: 3px;
        }

        .speed-btn {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .speed-btn:hover { background: #e9ecef; }
        .speed-btn.active { background: #0d6efd; color: white; border-color: #0d6efd; }

        .timeline-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .timeline-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #dee2e6;
            border-radius: 4px;
            outline: none;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #6c757d;
        }

        .current-time {
            font-size: 18px;
            font-weight: 600;
            min-width: 180px;
            text-align: center;
        }

        .frame-counter {
            display: none;
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 240px;
            font-size: 12px;
        }

        .info-panel h2 {
            font-size: 17px;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .title-icon.temperature {
            background: linear-gradient(135deg, #74add1 0%, #abd9e9 35%, #fee090 65%, #f46d43 100%);
        }
        .title-icon.humidity {
            background: linear-gradient(135deg, #b48f60 0%, #b6d69f 50%, #5e3a86 100%);
        }
        .info-panel .meta { color: #666; margin-bottom: 8px; line-height: 1.5; }

        /* Data Type Selector */
        .data-type-selector {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .data-type-selector:focus {
            outline: none;
            border-color: #0d6efd;
        }

        /* Social Links */
        .social-links {
            position: absolute;
            top: 10px;
            right: 50px;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            gap: 12px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .social-links a {
            color: rgba(0, 0, 0, 0.6);
            text-decoration: none;
            font-size: 20px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
        }

        .social-links a:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
        }

        /* Datetime Display */
        .datetime-display {
            margin-top: 12px;
            padding: 10px;
            background: #FFF4C1;
            border-radius: 8px;
            text-align: center;
            color: #333;
        }

        .datetime-display.night {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .day-night-icon {
            display: none;
        }

        .datetime-date {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .datetime-time {
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .day-night-icon {
            font-size: 20px;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 100px;
            left: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend h4 { margin-bottom: 8px; font-size: 13px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 12px; }
        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Temperature Chart */
        .temp-chart {
            position: absolute;
            bottom: 103px;
            right: 10px;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 320px;
        }

        .temp-chart h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 80px;
            background: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .chart-indicator {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #dc3545;
            pointer-events: none;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }

        .chart-temp-range {
            position: absolute;
            right: 5px;
            top: 5px;
            font-size: 10px;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 2px 4px;
            border-radius: 2px;
        }

        /* Hover Info */
        .hover-info {
            position: absolute;
            bottom: 248px;
            right: 10px;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .hover-info.active { display: block; }
        .hover-info .temp { font-size: 28px; font-weight: bold; color: #333; }
        .hover-info .coords { color: #666; font-size: 11px; margin-top: 4px; }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 30px 50px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .loading h3 { margin-bottom: 15px; }
        .loading-bar {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: #0d6efd;
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            /* Hide compare mode on mobile */
            .view-toggle { display: none !important; }
            .map-container.compare-mode .map-wrapper:nth-child(2) { display: none; }
            .map-container.compare-mode .map-wrapper { border-right: none; }
            .map-label { display: none !important; }
            .compare-legend { display: none !important; }
            .compare-time-display { display: none !important; }

            .info-panel {
                max-width: none;
                width: 160px;
                padding: 10px 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }
            .info-panel h2,
            .info-panel .meta,
            .stats-grid { display: none; }
            .info-panel .datetime-display {
                order: -1;
                margin: 0;
                padding: 6px 10px;
                white-space: nowrap;
                width: 100%;
            }
            .info-panel .datetime-date { font-size: 13px; }
            .info-panel .datetime-time { font-size: 11px; }
            /* ÊâãÊ©üÁâà: Âè™È°ØÁ§∫Âπ≥ÂùáÊ∫´Â∫¶ */
            .info-panel::after {
                content: attr(data-avg);
                font-size: 20px;
                font-weight: bold;
                color: #333;
            }
            .temp-chart,
            .legend,
            .hover-info { display: none !important; }
            .current-time,
            .speed-buttons { display: none; }
            /* ÊâãÊ©üÁâàÊí≠ÊîæÊåâÈàïÔºöÁî® CSS Ëâ≤Â°ä */
            .control-btn {
                font-size: 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .control-btn::before {
                content: '';
                display: block;
            }
            #btn-prev::before {
                width: 0;
                height: 0;
                border: 6px solid transparent;
                border-right: 10px solid #333;
            }
            #btn-play::before {
                width: 0;
                height: 0;
                border: 7px solid transparent;
                border-left: 11px solid #333;
                margin-left: 3px;
            }
            #btn-play.active::before {
                border: none;
                width: 4px;
                height: 12px;
                background: white;
                box-shadow: 6px 0 0 white;
                margin-left: 0;
            }
            #btn-next::before {
                width: 0;
                height: 0;
                border: 6px solid transparent;
                border-left: 10px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="map-container" id="map-container">
        <div class="map-wrapper">
            <div class="map" id="map"></div>
            <div class="map-label temperature">üå°Ô∏è Ê∫´Â∫¶ Temperature</div>
            <div class="compare-legend">
                <h5>Ê∫´Â∫¶ (¬∞C)</h5>
                <div class="legend-item"><div class="legend-color" style="background:#313695"></div>&lt;0¬∞</div>
                <div class="legend-item"><div class="legend-color" style="background:#74add1"></div>5-10¬∞</div>
                <div class="legend-item"><div class="legend-color" style="background:#fee090"></div>15-18¬∞</div>
                <div class="legend-item"><div class="legend-color" style="background:#f46d43"></div>20-25¬∞</div>
                <div class="legend-item"><div class="legend-color" style="background:#d73027"></div>&gt;25¬∞</div>
            </div>
        </div>
        <div class="map-wrapper">
            <div class="map" id="map2"></div>
            <div class="map-label humidity">üíß ÊøïÂ∫¶ Humidity</div>
            <div class="compare-legend">
                <h5>ÊøïÂ∫¶ (%)</h5>
                <div class="legend-item"><div class="legend-color" style="background:#b48f60"></div>&lt;40%</div>
                <div class="legend-item"><div class="legend-color" style="background:#b6d69f"></div>60-70%</div>
                <div class="legend-item"><div class="legend-color" style="background:#64b6e1"></div>70-80%</div>
                <div class="legend-item"><div class="legend-color" style="background:#5a6fc2"></div>80-90%</div>
                <div class="legend-item"><div class="legend-color" style="background:#5e3a86"></div>&gt;90%</div>
            </div>
        </div>
    </div>

    <div class="compare-time-display" id="compare-time-display">
        <div class="date" id="compare-date">--</div>
        <div class="time" id="compare-time">--:--</div>
    </div>

    <div class="social-links">
        <a href="https://github.com/ianlkl11234s/taiwan-weather-timelapse" target="_blank" title="GitHub">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </a>
        <a href="https://www.threads.com/@ianlkl1314" target="_blank" title="Threads">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.59 12c.025 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.182.408-2.256 1.332-3.023.88-.73 2.106-1.146 3.552-1.204 1.074-.043 2.068.06 2.968.306-.034-.78-.181-1.407-.449-1.878-.353-.622-.942-1.055-1.797-1.322-.896-.28-2.006-.347-3.209-.194l-.271-2.017c1.509-.19 2.888-.089 4.105.303 1.238.398 2.209 1.09 2.805 2.003.538.823.849 1.822.928 2.973.321.123.634.266.934.43 1.14.623 2.035 1.501 2.588 2.543.727 1.368.848 3.313-.657 5.722-1.935 3.093-5.163 3.588-7.163 3.606zm.704-9.893c-1.156.047-2.078.333-2.668.83-.526.443-.769.974-.726 1.582.046.638.375 1.153.978 1.533.653.412 1.502.569 2.381.522 1.097-.06 1.943-.466 2.51-1.169.51-.631.822-1.508.926-2.594-.994-.29-2.113-.434-3.401-.704z"/>
            </svg>
        </a>
    </div>

    <div class="time-controller">
        <div class="control-buttons">
            <button class="control-btn" id="btn-prev" title="Previous">&#x23EE;</button>
            <button class="control-btn" id="btn-play" title="Play/Pause">&#x25B6;</button>
            <button class="control-btn" id="btn-next" title="Next">&#x23ED;</button>
        </div>

        <div class="view-toggle">
            <button class="view-toggle-btn active" data-view="single">ÂñÆ‰∏Ä</button>
            <button class="view-toggle-btn" data-view="compare">ÊØîËºÉ</button>
        </div>

        <div class="speed-buttons">
            <button class="speed-btn" data-speed="1">1x</button>
            <button class="speed-btn" data-speed="2">2x</button>
            <button class="speed-btn active" data-speed="4">4x</button>
            <button class="speed-btn" data-speed="8">8x</button>
        </div>

        <div class="timeline-container">
            <input type="range" class="timeline-slider" id="timeline" min="0" max="100" value="0">
            <div class="timeline-labels">
                <span id="start-time">--</span>
                <span id="end-time">--</span>
            </div>
        </div>

        <div class="current-time" id="current-time">Loading...</div>
        <div class="frame-counter" id="frame-counter">-- / --</div>
    </div>

    <div class="info-panel" id="info-panel">
        <h2><span class="title-icon temperature" id="title-icon"></span><span id="panel-title">Âè∞ÁÅ£Ê∫´Â∫¶ËÆäÂåñ</span></h2>
        <select class="data-type-selector" id="data-type-selector">
            <option value="temperature">Ê∫´Â∫¶ Temperature</option>
            <option value="humidity">ÊøïÂ∫¶ Humidity</option>
        </select>
        <div class="meta" id="data-meta">
            <strong>Source:</strong> Central Weather Administration<br>
            <strong>Dataset:</strong> O-A0038-003<br>
            <strong>Resolution:</strong> 0.03&#176; (~3.3 km)
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="stat-min">--</div>
                <div class="stat-label">Min</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-max">--</div>
                <div class="stat-label">Max</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-avg">--</div>
                <div class="stat-label">Avg</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-points">--</div>
                <div class="stat-label">Points</div>
            </div>
        </div>
        <div class="datetime-display" id="datetime-display">
            <div class="datetime-date" id="display-date">--</div>
            <div class="datetime-time">
                <span class="day-night-icon" id="day-night-icon">--</span>
                <span id="display-time">--:--</span>
                <span id="day-night-text">--</span>
            </div>
        </div>
    </div>

    <div class="temp-chart">
        <h4>Average Temperature Trend</h4>
        <div class="chart-container">
            <canvas class="chart-canvas" id="chart-canvas"></canvas>
            <div class="chart-indicator" id="chart-indicator"></div>
            <div class="chart-temp-range" id="chart-temp-range">--</div>
        </div>
        <div class="chart-labels">
            <span id="chart-start">--</span>
            <span id="chart-end">--</span>
        </div>
    </div>

    <div class="legend" id="legend">
        <div id="legend-temperature">
            <h4>Temperature (&#176;C)</h4>
            <div class="legend-item"><div class="legend-color" style="background:#313695"></div> &lt; 0&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#4575b4"></div> 0 ~ 5&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#74add1"></div> 5 ~ 10&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#abd9e9"></div> 10 ~ 15&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#fee090"></div> 15 ~ 18&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#fdae61"></div> 18 ~ 20&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#f46d43"></div> 20 ~ 25&#176;C</div>
            <div class="legend-item"><div class="legend-color" style="background:#d73027"></div> &gt; 25&#176;C</div>
        </div>
        <div id="legend-humidity" style="display:none;">
            <h4>Humidity (%)</h4>
            <div class="legend-item"><div class="legend-color" style="background:#b48f60"></div> &lt; 40% Ê•µ‰πæ</div>
            <div class="legend-item"><div class="legend-color" style="background:#d6bb7e"></div> 40 ~ 50% ‰πæÁá•</div>
            <div class="legend-item"><div class="legend-color" style="background:#e6dfaa"></div> 50 ~ 60% Á®ç‰πæ</div>
            <div class="legend-item"><div class="legend-color" style="background:#b6d69f"></div> 60 ~ 70% ËàíÈÅ©</div>
            <div class="legend-item"><div class="legend-color" style="background:#64b6e1"></div> 70 ~ 80% ÊøïÊΩ§</div>
            <div class="legend-item"><div class="legend-color" style="background:#5a6fc2"></div> 80 ~ 90% ÊΩÆÊøï</div>
            <div class="legend-item"><div class="legend-color" style="background:#5e3a86"></div> &gt; 90% Ê•µÊøï</div>
        </div>
    </div>

    <div class="hover-info" id="hover-info">
        <div class="temp" id="hover-temp">--&#176;C</div>
        <div class="coords" id="hover-coords">--</div>
    </div>

    <div class="loading" id="loading">
        <h3>Loading temperature data...</h3>
        <div class="loading-bar">
            <div class="loading-progress" id="loading-progress"></div>
        </div>
        <div style="margin-top: 10px; color: #666;" id="loading-text">Preparing...</div>
    </div>

    <script>
        // View mode state
        let isCompareMode = false;
        let currentDataType = 'temperature';

        // Initialize maps
        const map = L.map('map', { zoomControl: false }).setView([23.7, 121.0], 7);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19
        }).addTo(map);

        // Initialize second map for compare mode
        const map2 = L.map('map2', { zoomControl: false }).setView([23.7, 121.0], 7);
        L.control.zoom({ position: 'topright' }).addTo(map2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '',
            maxZoom: 19
        }).addTo(map2);

        // Sync maps - when one moves, the other follows
        let isSyncing = false;
        function syncMaps(sourceMap, targetMap) {
            if (isSyncing) return;
            isSyncing = true;
            targetMap.setView(sourceMap.getCenter(), sourceMap.getZoom(), { animate: false });
            isSyncing = false;
        }
        map.on('move', () => syncMaps(map, map2));
        map2.on('move', () => syncMaps(map2, map));

        // Temperature color function
        function getTemperatureColor(temp) {
            if (temp < 0) return '#313695';
            if (temp < 5) return '#4575b4';
            if (temp < 10) return '#74add1';
            if (temp < 15) return '#abd9e9';
            if (temp < 18) return '#fee090';
            if (temp < 20) return '#fdae61';
            if (temp < 25) return '#f46d43';
            return '#d73027';
        }

        // Humidity color function (Windy style)
        function getHumidityColor(humidity) {
            if (humidity < 40) return '#b48f60';  // Ê•µ‰πæ (Ê£ïËâ≤)
            if (humidity < 50) return '#d6bb7e';  // ‰πæÁá• (Ê∑∫Ê£ï)
            if (humidity < 60) return '#e6dfaa';  // Á®ç‰πæ (ÈªÉËâ≤)
            if (humidity < 70) return '#b6d69f';  // ËàíÈÅ© (Ê∑∫Á∂†)
            if (humidity < 80) return '#64b6e1';  // ÊøïÊΩ§ (Ê∑∫Ëóç)
            if (humidity < 90) return '#5a6fc2';  // ÊΩÆÊøï (Ê∑±Ëóç)
            return '#5e3a86';                     // Ê•µÊøï (Á¥´Ëâ≤)
        }

        // Get color based on current data type
        function getColor(value) {
            return currentDataType === 'humidity'
                ? getHumidityColor(value)
                : getTemperatureColor(value);
        }

        // Time formatting
        function formatTime(isoString) {
            const d = new Date(isoString);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const minute = String(d.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hour}:${minute}`;
        }

        // Check if daytime (09:00 - 18:00)
        function isDaytime(isoString) {
            const d = new Date(isoString);
            const hour = d.getHours();
            return hour >= 9 && hour < 18;
        }

        // Format date display
        function formatDateDisplay(isoString) {
            const d = new Date(isoString);
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const weekday = weekdays[d.getDay()];
            return `${year}/${month}/${day} (${weekday})`;
        }

        // Format time display
        function formatTimeDisplay(isoString) {
            const d = new Date(isoString);
            const hour = String(d.getHours()).padStart(2, '0');
            const minute = String(d.getMinutes()).padStart(2, '0');
            return `${hour}:${minute}`;
        }

        // Timelapse Player Class
        class WeatherTimelapse {
            constructor() {
                this.data = null;
                this.frames = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.speed = 4;
                this.intervalMs = 1000;
                this.intervalId = null;
                this.gridLayer = null;
                this.rectangles = [];
                this.chartCanvas = null;
                this.chartCtx = null;
                this.avgValues = [];
                this.valueMin = 0;
                this.valueMax = 30;
                this.dataType = 'temperature';

                // Compare mode properties
                this.isCompareMode = false;
                this.tempData = null;
                this.humidData = null;
                this.tempFrames = [];
                this.humidFrames = [];
                this.tempRectangles = [];
                this.humidRectangles = [];

                this.initControls();
                this.initDataTypeSelector();
                this.initViewToggle();
            }

            initViewToggle() {
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const view = e.target.dataset.view;
                        document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');

                        if (view === 'compare') {
                            await this.enterCompareMode();
                        } else {
                            this.exitCompareMode();
                        }
                    });
                });
            }

            async enterCompareMode() {
                this.pause();
                this.isCompareMode = true;
                isCompareMode = true;
                document.getElementById('map-container').classList.add('compare-mode');

                // Hide single view controls, show compare time display
                document.getElementById('data-type-selector').style.display = 'none';
                document.getElementById('info-panel').style.display = 'none';
                document.querySelector('.temp-chart').style.display = 'none';
                document.getElementById('legend').style.display = 'none';
                document.getElementById('compare-time-display').style.display = 'block';

                // Clear single view grid
                this.clearGrid();

                // Show loading
                const loadingEl = document.getElementById('loading');
                const progressEl = document.getElementById('loading-progress');
                const textEl = document.getElementById('loading-text');
                loadingEl.style.display = 'block';
                progressEl.style.width = '0%';
                textEl.textContent = 'Loading compare data...';

                // Load both datasets
                await this.loadCompareData();

                // Invalidate map sizes and center on Taiwan
                setTimeout(() => {
                    map.invalidateSize();
                    map2.invalidateSize();
                    // Center both maps on Taiwan with appropriate zoom for split view
                    const taiwanCenter = [23.5, 121.0];
                    const compareZoom = 7.5;
                    map.setView(taiwanCenter, compareZoom, { animate: false });
                    map2.setView(taiwanCenter, compareZoom, { animate: false });
                }, 150);

                loadingEl.style.display = 'none';
            }

            exitCompareMode() {
                this.pause();
                this.isCompareMode = false;
                isCompareMode = false;
                document.getElementById('map-container').classList.remove('compare-mode');

                // Show single view controls, hide compare time display
                document.getElementById('data-type-selector').style.display = 'block';
                document.getElementById('info-panel').style.display = 'block';
                document.querySelector('.temp-chart').style.display = 'block';
                document.getElementById('legend').style.display = 'block';
                document.getElementById('compare-time-display').style.display = 'none';

                // Clear compare mode grids
                this.clearCompareGrids();

                // Restore single view grid and timeline
                document.getElementById('timeline').max = this.frames.length - 1;
                document.getElementById('start-time').textContent = formatTime(this.frames[0].time);
                document.getElementById('end-time').textContent = formatTime(this.frames[this.frames.length - 1].time);

                // Find closest frame index for current time
                this.currentIndex = Math.min(this.currentIndex, this.frames.length - 1);

                // Invalidate map size after layout change, then recreate grid
                setTimeout(() => {
                    map.invalidateSize();
                    this.createGrid();
                    this.renderFrame(this.currentIndex);
                }, 100);
            }

            clearCompareGrids() {
                for (const rect of this.tempRectangles) {
                    map.removeLayer(rect);
                }
                for (const rect of this.humidRectangles) {
                    map2.removeLayer(rect);
                }
                this.tempRectangles = [];
                this.humidRectangles = [];
            }

            async loadCompareData() {
                const progressEl = document.getElementById('loading-progress');
                const textEl = document.getElementById('loading-text');

                // Load temperature data
                textEl.textContent = 'Loading temperature data...';
                progressEl.style.width = '25%';
                const tempResponse = await fetch('temperature_timelapse_data.json');
                this.tempData = await tempResponse.json();

                // Load humidity data
                textEl.textContent = 'Loading humidity data...';
                progressEl.style.width = '50%';
                const humidResponse = await fetch('humidity_timelapse_data.json');
                this.humidData = await humidResponse.json();

                // Filter and align frames by time
                textEl.textContent = 'Processing data...';
                progressEl.style.width = '75%';
                this.alignCompareFrames();

                // Create grids for both maps
                textEl.textContent = 'Creating grids...';
                progressEl.style.width = '90%';
                this.createCompareGrids();

                // Render first frame
                this.renderCompareFrame(this.currentIndex);
                progressEl.style.width = '100%';
            }

            alignCompareFrames() {
                // Apply same 30-day filter as single view
                const startDate = new Date('2025-12-27T00:00:00');
                const now = new Date();
                const thirtyDaysAgo = new Date(now);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                thirtyDaysAgo.setHours(0, 0, 0, 0);
                const cutoffDate = startDate > thirtyDaysAgo ? startDate : thirtyDaysAgo;

                // Create time-indexed maps with filtered data
                const tempByTime = new Map();
                const humidByTime = new Map();

                for (const frame of this.tempData.frames) {
                    const frameDate = new Date(frame.time);
                    if (frameDate >= cutoffDate) {
                        const timeKey = frame.time.substring(0, 16); // YYYY-MM-DDTHH:MM
                        tempByTime.set(timeKey, frame);
                    }
                }

                for (const frame of this.humidData.frames) {
                    const frameDate = new Date(frame.time);
                    if (frameDate >= cutoffDate) {
                        const timeKey = frame.time.substring(0, 16);
                        humidByTime.set(timeKey, frame);
                    }
                }

                // Find common times
                this.tempFrames = [];
                this.humidFrames = [];

                for (const [timeKey, tempFrame] of tempByTime) {
                    if (humidByTime.has(timeKey)) {
                        this.tempFrames.push(tempFrame);
                        this.humidFrames.push(humidByTime.get(timeKey));
                    }
                }

                // Sort by time
                this.tempFrames.sort((a, b) => new Date(a.time) - new Date(b.time));
                this.humidFrames.sort((a, b) => new Date(a.time) - new Date(b.time));

                // Update timeline
                if (this.tempFrames.length > 0) {
                    document.getElementById('start-time').textContent = formatTime(this.tempFrames[0].time);
                    document.getElementById('end-time').textContent = formatTime(this.tempFrames[this.tempFrames.length - 1].time);
                    document.getElementById('timeline').max = this.tempFrames.length - 1;
                    this.currentIndex = Math.min(this.currentIndex, this.tempFrames.length - 1);
                }
            }

            createCompareGrids() {
                const tempGeo = this.tempData.metadata.geo_info;
                const humidGeo = this.humidData.metadata.geo_info;
                const resolution = tempGeo.resolution_deg || 0.03;

                // Create temperature grid on map1
                if (this.tempFrames.length > 0) {
                    const firstFrame = this.tempFrames[0];
                    for (let row = 0; row < firstFrame.data.length; row++) {
                        for (let col = 0; col < firstFrame.data[row].length; col++) {
                            const val = firstFrame.data[row][col];
                            if (val === null || val < -900) continue;

                            const lat = tempGeo.bottom_left_lat + row * resolution;
                            const lon = tempGeo.bottom_left_lon + col * resolution;
                            const bounds = [
                                [lat - resolution/2, lon - resolution/2],
                                [lat + resolution/2, lon + resolution/2]
                            ];

                            const rect = L.rectangle(bounds, {
                                color: getTemperatureColor(val),
                                fillColor: getTemperatureColor(val),
                                fillOpacity: 0.7,
                                weight: 0
                            }).addTo(map);

                            rect._gridRow = row;
                            rect._gridCol = col;
                            this.tempRectangles.push(rect);
                        }
                    }
                }

                // Create humidity grid on map2
                if (this.humidFrames.length > 0) {
                    const firstFrame = this.humidFrames[0];
                    for (let row = 0; row < firstFrame.data.length; row++) {
                        for (let col = 0; col < firstFrame.data[row].length; col++) {
                            const val = firstFrame.data[row][col];
                            if (val === null || val < -900) continue;

                            const lat = humidGeo.bottom_left_lat + row * resolution;
                            const lon = humidGeo.bottom_left_lon + col * resolution;
                            const bounds = [
                                [lat - resolution/2, lon - resolution/2],
                                [lat + resolution/2, lon + resolution/2]
                            ];

                            const rect = L.rectangle(bounds, {
                                color: getHumidityColor(val),
                                fillColor: getHumidityColor(val),
                                fillOpacity: 0.7,
                                weight: 0
                            }).addTo(map2);

                            rect._gridRow = row;
                            rect._gridCol = col;
                            this.humidRectangles.push(rect);
                        }
                    }
                }
            }

            renderCompareFrame(index) {
                if (index < 0 || index >= this.tempFrames.length) return;

                this.currentIndex = index;
                const tempFrame = this.tempFrames[index];
                const humidFrame = this.humidFrames[index];

                // Update temperature grid
                for (const rect of this.tempRectangles) {
                    const row = rect._gridRow;
                    const col = rect._gridCol;
                    if (tempFrame.data[row] && tempFrame.data[row][col] !== undefined) {
                        const val = tempFrame.data[row][col];
                        if (val !== null && val > -900) {
                            const color = getTemperatureColor(val);
                            rect.setStyle({ color, fillColor: color, opacity: 1, fillOpacity: 0.7 });
                        } else {
                            rect.setStyle({ opacity: 0, fillOpacity: 0 });
                        }
                    }
                }

                // Update humidity grid
                for (const rect of this.humidRectangles) {
                    const row = rect._gridRow;
                    const col = rect._gridCol;
                    if (humidFrame.data[row] && humidFrame.data[row][col] !== undefined) {
                        const val = humidFrame.data[row][col];
                        if (val !== null && val > -900) {
                            const color = getHumidityColor(val);
                            rect.setStyle({ color, fillColor: color, opacity: 1, fillOpacity: 0.7 });
                        } else {
                            rect.setStyle({ opacity: 0, fillOpacity: 0 });
                        }
                    }
                }

                // Update UI with date and time
                const dateStr = formatDateDisplay(tempFrame.time);
                const timeStr = formatTimeDisplay(tempFrame.time);
                document.getElementById('current-time').textContent = `${dateStr} ${timeStr}`;
                document.getElementById('timeline').value = index;

                // Update compare time display
                const compareTimeDisplay = document.getElementById('compare-time-display');
                document.getElementById('compare-date').textContent = dateStr;
                document.getElementById('compare-time').textContent = timeStr;
                const isDay = isDaytime(tempFrame.time);
                compareTimeDisplay.className = 'compare-time-display' + (isDay ? '' : ' night');
            }

            initDataTypeSelector() {
                const selector = document.getElementById('data-type-selector');
                selector.addEventListener('change', async (e) => {
                    const newType = e.target.value;
                    if (newType !== this.dataType) {
                        this.dataType = newType;
                        currentDataType = newType;
                        await this.switchDataType(newType);
                    }
                });
            }

            async switchDataType(dataType) {
                this.pause();

                // Show loading
                const loadingEl = document.getElementById('loading');
                const progressEl = document.getElementById('loading-progress');
                const textEl = document.getElementById('loading-text');
                loadingEl.style.display = 'block';
                progressEl.style.width = '0%';
                textEl.textContent = `Switching to ${dataType}...`;

                // Update UI
                this.updateUIForDataType(dataType);

                // Clear existing grid
                this.clearGrid();

                // Load new data
                await this.loadData(dataType);
            }

            updateUIForDataType(dataType) {
                const titleIcon = document.getElementById('title-icon');
                const panelTitle = document.getElementById('panel-title');
                const dataMeta = document.getElementById('data-meta');
                const legendTemp = document.getElementById('legend-temperature');
                const legendHumid = document.getElementById('legend-humidity');
                const chartTitle = document.querySelector('.temp-chart h4');

                if (dataType === 'humidity') {
                    titleIcon.className = 'title-icon humidity';
                    panelTitle.textContent = 'Âè∞ÁÅ£ÊøïÂ∫¶ËÆäÂåñ';
                    dataMeta.innerHTML = `
                        <strong>Source:</strong> Central Weather Administration<br>
                        <strong>Data:</strong> Weather Stations (Interpolated)<br>
                        <strong>Method:</strong> scipy.griddata cubic
                    `;
                    legendTemp.style.display = 'none';
                    legendHumid.style.display = 'block';
                    chartTitle.textContent = 'Average Humidity Trend';
                } else {
                    titleIcon.className = 'title-icon temperature';
                    panelTitle.textContent = 'Âè∞ÁÅ£Ê∫´Â∫¶ËÆäÂåñ';
                    dataMeta.innerHTML = `
                        <strong>Source:</strong> Central Weather Administration<br>
                        <strong>Dataset:</strong> O-A0038-003<br>
                        <strong>Resolution:</strong> 0.03¬∞ (~3.3 km)
                    `;
                    legendTemp.style.display = 'block';
                    legendHumid.style.display = 'none';
                    chartTitle.textContent = 'Average Temperature Trend';
                }
            }

            clearGrid() {
                for (const rect of this.rectangles) {
                    map.removeLayer(rect);
                }
                this.rectangles = [];
            }

            initControls() {
                document.getElementById('btn-play').addEventListener('click', () => {
                    if (this.isPlaying) {
                        this.pause();
                    } else {
                        this.play();
                    }
                });

                document.getElementById('btn-prev').addEventListener('click', () => {
                    this.pause();
                    const maxIndex = this.isCompareMode ? this.tempFrames.length - 1 : this.frames.length - 1;
                    this.seekTo(Math.max(0, this.currentIndex - 1));
                });

                document.getElementById('btn-next').addEventListener('click', () => {
                    this.pause();
                    const maxIndex = this.isCompareMode ? this.tempFrames.length - 1 : this.frames.length - 1;
                    this.seekTo(Math.min(maxIndex, this.currentIndex + 1));
                });

                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.setSpeed(parseInt(e.target.dataset.speed));
                    });
                });

                document.getElementById('timeline').addEventListener('input', (e) => {
                    this.pause();
                    this.seekTo(parseInt(e.target.value));
                });
            }

            async loadData(dataType = 'temperature') {
                const loadingEl = document.getElementById('loading');
                const progressEl = document.getElementById('loading-progress');
                const textEl = document.getElementById('loading-text');

                const dataFile = dataType === 'humidity'
                    ? 'humidity_timelapse_data.json'
                    : 'temperature_timelapse_data.json';

                try {
                    textEl.textContent = `Downloading ${dataType} data...`;
                    progressEl.style.width = '20%';

                    const response = await fetch(dataFile);
                    if (!response.ok) throw new Error(`Cannot load ${dataType} data`);

                    progressEl.style.width = '60%';
                    textEl.textContent = 'Parsing data...';

                    this.data = await response.json();

                    // ÈÅéÊøæË≥áÊñôÔºöÂæû 12/27 ÈñãÂßãÔºåÊúÄÂ§ö‰øùÁïô 30 Â§©
                    const startDate = new Date('2025-12-27T00:00:00');
                    const now = new Date();
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    thirtyDaysAgo.setHours(0, 0, 0, 0);
                    const cutoffDate = startDate > thirtyDaysAgo ? startDate : thirtyDaysAgo;

                    this.frames = this.data.frames.filter(frame => {
                        const frameDate = new Date(frame.time);
                        return frameDate >= cutoffDate;
                    });

                    progressEl.style.width = '80%';
                    textEl.textContent = 'Initializing map...';

                    if (this.frames.length > 0) {
                        document.getElementById('start-time').textContent = formatTime(this.frames[0].time);
                        document.getElementById('end-time').textContent = formatTime(this.frames[this.frames.length - 1].time);
                        document.getElementById('timeline').max = this.frames.length - 1;
                    }

                    this.initChart();
                    this.createGrid();
                    this.renderFrame(0);

                    progressEl.style.width = '100%';

                    const geo = this.data.metadata.geo_info;
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        // ÊâãÊ©üÁâàÔºö‰ª•Âè∞ÁÅ£Êú¨Â≥∂ÁÇ∫‰∏≠ÂøÉ
                        map.setView([23.5, 120.9], 7);
                    } else {
                        map.fitBounds([
                            [geo.bottom_left_lat, geo.bottom_left_lon],
                            [geo.top_right_lat, geo.top_right_lon]
                        ], { padding: [20, 20] });
                    }

                    setTimeout(() => {
                        loadingEl.style.display = 'none';
                    }, 300);

                } catch (error) {
                    console.error('Load failed:', error);
                    textEl.textContent = 'Load failed: ' + error.message;
                    progressEl.style.background = '#dc3545';
                }
            }

            createGrid() {
                const geo = this.data.metadata.geo_info;
                const resolution = geo.resolution_deg || 0.03;
                const firstFrame = this.frames[0];

                if (!firstFrame || !firstFrame.data) return;

                const hoverInfo = document.getElementById('hover-info');
                const hoverTemp = document.getElementById('hover-temp');
                const hoverCoords = document.getElementById('hover-coords');

                for (let row = 0; row < firstFrame.data.length; row++) {
                    for (let col = 0; col < firstFrame.data[row].length; col++) {
                        const temp = firstFrame.data[row][col];
                        if (temp === null || temp < -900) continue;

                        const lat = geo.bottom_left_lat + row * resolution;
                        const lon = geo.bottom_left_lon + col * resolution;

                        const bounds = [
                            [lat - resolution/2, lon - resolution/2],
                            [lat + resolution/2, lon + resolution/2]
                        ];

                        const rect = L.rectangle(bounds, {
                            color: getColor(temp),
                            fillColor: getColor(temp),
                            fillOpacity: 0.7,
                            weight: 0
                        }).addTo(map);

                        rect._gridRow = row;
                        rect._gridCol = col;

                        const self = this;
                        rect.on('mouseover', function(e) {
                            this.setStyle({ fillOpacity: 1, weight: 1, color: '#333' });
                            const currentValue = this._currentValue;
                            if (currentValue !== null && currentValue > -900) {
                                hoverInfo.classList.add('active');
                                const unit = self.dataType === 'humidity' ? '%' : '¬∞C';
                                hoverTemp.textContent = currentValue.toFixed(1) + unit;
                                hoverCoords.textContent = lat.toFixed(2) + '¬∞N, ' + lon.toFixed(2) + '¬∞E';
                            }
                        });

                        rect.on('mouseout', function(e) {
                            this.setStyle({ fillOpacity: 0.7, weight: 0 });
                            hoverInfo.classList.remove('active');
                        });

                        // ÊâãÊ©üÁâàÈªûÊìäÈ°ØÁ§∫Êï∏ÂÄº
                        rect.on('click', function(e) {
                            L.DomEvent.stopPropagation(e);
                            const currentValue = this._currentValue;
                            if (currentValue !== null && currentValue > -900) {
                                hoverInfo.classList.add('active');
                                const unit = self.dataType === 'humidity' ? '%' : '¬∞C';
                                hoverTemp.textContent = currentValue.toFixed(1) + unit;
                                hoverCoords.textContent = lat.toFixed(2) + '¬∞N, ' + lon.toFixed(2) + '¬∞E';
                            }
                        });

                        this.rectangles.push(rect);
                    }
                }
            }

            initChart() {
                this.avgValues = this.frames.map(f => f.stats?.avg || null).filter(t => t !== null);

                if (this.avgValues.length === 0) return;

                this.valueMin = Math.floor(Math.min(...this.avgValues) - 2);
                this.valueMax = Math.ceil(Math.max(...this.avgValues) + 2);

                // Adjust range for humidity (0-100%)
                if (this.dataType === 'humidity') {
                    this.valueMin = Math.max(0, this.valueMin);
                    this.valueMax = Math.min(100, this.valueMax);
                }

                document.getElementById('chart-start').textContent = formatTime(this.frames[0].time);
                document.getElementById('chart-end').textContent = formatTime(this.frames[this.frames.length - 1].time);
                const unit = this.dataType === 'humidity' ? '%' : '¬∞';
                document.getElementById('chart-temp-range').textContent = `${this.valueMin}${unit} ~ ${this.valueMax}${unit}`;

                this.chartCanvas = document.getElementById('chart-canvas');
                this.chartCtx = this.chartCanvas.getContext('2d');

                const rect = this.chartCanvas.getBoundingClientRect();
                this.chartCanvas.width = rect.width * 2;
                this.chartCanvas.height = rect.height * 2;
                this.chartCtx.scale(2, 2);

                this.drawChart();
            }

            drawChart() {
                if (!this.chartCtx) return;

                const ctx = this.chartCtx;
                const canvas = this.chartCanvas;
                const width = canvas.width / 2;
                const height = canvas.height / 2;
                const padding = 5;

                ctx.clearRect(0, 0, width, height);

                const framesCount = this.frames.length;
                const barWidth = (width - padding * 2) / framesCount;

                for (let i = 0; i < framesCount; i++) {
                    const frame = this.frames[i];
                    const isDay = isDaytime(frame.time);
                    ctx.fillStyle = isDay ? 'rgba(255, 236, 179, 0.4)' : 'rgba(63, 81, 181, 0.15)';
                    ctx.fillRect(padding + i * barWidth, 0, barWidth, height);
                }

                ctx.beginPath();
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 1.5;

                let started = false;
                for (let i = 0; i < this.frames.length; i++) {
                    const temp = this.frames[i].stats?.avg;
                    if (temp === null || temp === undefined) continue;

                    const x = padding + (i / (this.frames.length - 1)) * (width - padding * 2);
                    const y = height - padding - ((temp - this.valueMin) / (this.valueMax - this.valueMin)) * (height - padding * 2);

                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                ctx.fillStyle = '#e74c3c';
                for (let i = 0; i < this.frames.length; i++) {
                    const temp = this.frames[i].stats?.avg;
                    if (temp === null || temp === undefined) continue;

                    const x = padding + (i / (this.frames.length - 1)) * (width - padding * 2);
                    const y = height - padding - ((temp - this.valueMin) / (this.valueMax - this.valueMin)) * (height - padding * 2);

                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            updateChartIndicator(index) {
                const indicator = document.getElementById('chart-indicator');
                const container = indicator.parentElement;
                const width = container.offsetWidth;
                const padding = 5;

                const x = padding + (index / (this.frames.length - 1)) * (width - padding * 2);
                indicator.style.left = x + 'px';
            }

            renderFrame(index) {
                if (index < 0 || index >= this.frames.length) return;

                this.currentIndex = index;
                const frame = this.frames[index];

                for (const rect of this.rectangles) {
                    const row = rect._gridRow;
                    const col = rect._gridCol;

                    if (frame.data[row] && frame.data[row][col] !== undefined) {
                        const temp = frame.data[row][col];
                        rect._currentValue = temp;

                        if (temp !== null && temp > -900) {
                            const color = getColor(temp);
                            rect.setStyle({ color: color, fillColor: color });
                            rect.setStyle({ opacity: 1, fillOpacity: 0.7 });
                        } else {
                            rect.setStyle({ opacity: 0, fillOpacity: 0 });
                        }
                    }
                }

                document.getElementById('current-time').textContent = formatTime(frame.time);
                document.getElementById('frame-counter').textContent = `${index + 1} / ${this.frames.length}`;
                document.getElementById('timeline').value = index;

                if (frame.stats) {
                    const unit = this.dataType === 'humidity' ? '%' : '¬∞';
                    document.getElementById('stat-min').textContent =
                        frame.stats.min !== null ? frame.stats.min.toFixed(1) + unit : '--';
                    document.getElementById('stat-max').textContent =
                        frame.stats.max !== null ? frame.stats.max.toFixed(1) + unit : '--';
                    document.getElementById('stat-avg').textContent =
                        frame.stats.avg !== null ? frame.stats.avg.toFixed(1) + unit : '--';
                    document.getElementById('stat-points').textContent =
                        frame.stats.valid_points ? frame.stats.valid_points.toLocaleString() : '--';
                }

                const datetimeDisplay = document.getElementById('datetime-display');
                const isDay = isDaytime(frame.time);
                datetimeDisplay.className = 'datetime-display' + (isDay ? '' : ' night');
                // Êõ¥Êñ∞ÊâãÊ©üÁâàÂπ≥ÂùáÂÄºÈ°ØÁ§∫
                const mobileUnit = this.dataType === 'humidity' ? '%' : '¬∞';
                document.querySelector('.info-panel').dataset.avg =
                    frame.stats?.avg !== null ? frame.stats.avg.toFixed(1) + mobileUnit : '--';
                document.getElementById('display-date').textContent = formatDateDisplay(frame.time);
                document.getElementById('display-time').textContent = formatTimeDisplay(frame.time);
                document.getElementById('day-night-icon').textContent = isDay ? '‚òÄÔ∏è' : 'üåô';
                document.getElementById('day-night-text').textContent = isDay ? 'Day' : 'Night';

                this.updateChartIndicator(index);
            }

            play() {
                const framesLength = this.isCompareMode ? this.tempFrames.length : this.frames.length;
                if (framesLength === 0) return;

                this.isPlaying = true;
                document.getElementById('btn-play').innerHTML = '&#x23F8;';
                document.getElementById('btn-play').classList.add('active');

                this.intervalId = setInterval(() => {
                    let nextIndex = this.currentIndex + 1;
                    if (nextIndex >= framesLength) {
                        nextIndex = 0;
                    }
                    if (this.isCompareMode) {
                        this.renderCompareFrame(nextIndex);
                    } else {
                        this.renderFrame(nextIndex);
                    }
                }, this.intervalMs / this.speed);
            }

            pause() {
                this.isPlaying = false;
                document.getElementById('btn-play').innerHTML = '&#x25B6;';
                document.getElementById('btn-play').classList.remove('active');

                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
            }

            setSpeed(speed) {
                this.speed = speed;
                if (this.isPlaying) {
                    this.pause();
                    this.play();
                }
            }

            seekTo(index) {
                if (this.isCompareMode) {
                    this.renderCompareFrame(index);
                } else {
                    this.renderFrame(index);
                }
            }
        }

        // ÈªûÂú∞ÂúñÁ©∫ÁôΩËôïÈóúÈñâÊ∫´Â∫¶È°ØÁ§∫
        map.on('click', function() {
            document.getElementById('hover-info').classList.remove('active');
        });

        // Initialize
        const timelapse = new WeatherTimelapse();
        timelapse.loadData('temperature');
    </script>
</body>
</html>
